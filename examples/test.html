<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.7.2/angular.js"></script>

    <script src="../node_modules/three/build/three.js"></script>
    <script src="../node_modules/cannon/build/cannon.js"></script>
    <script src="../node_modules/three/examples/js/controls/OrbitControls.js"></script>
    <script src="../node_modules/three/examples/js/libs/stats.min.js"></script>

    <script src="../lib/dice.js"></script>
</head>
<body>

<table border>
    <tr>
        <th colspan=3>d4</th>
        <th colspan=3>d6</th>
        <th colspan=3>d8</th>
        <th colspan=3>d10</th>
        <th colspan=3>d12</th>
        <th colspan=3>d20</th>
    </tr>
    <tr>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
        <td><button>-</button></td>
        <td><span>0</span></td>
        <td><button>+</button></td>
    </tr>
    <tr>
        <td colspan=3><span>0</span></td>
        <td colspan=3><span>0</span></td>
        <td colspan=3><span>0</span></td>
        <td colspan=3><span>0</span></td>
        <td colspan=3><span>0</span></td>
        <td colspan=3><span>0</span></td>
    </tr>
</table>
<div style="position: fixed; right: 0">
    <button onclick="randomDiceThrow()">Roll</button>
    <button onclick="controls.reset()">Reset</button>
    </div>
<div id="ThreeJS" style="position: absolute; right:0px; bottom:0px"></div>

<script>
// standard global variables
var container, scene, camera, renderer, controls, stats, world, dice = [];
init();
// FUNCTIONS
function init()
{
	// SCENE
	scene = new THREE.Scene();
	// CAMERA
	var SCREEN_WIDTH = window.innerWidth/2, SCREEN_HEIGHT = window.innerHeight/2;
	var VIEW_ANGLE = 45, ASPECT = SCREEN_WIDTH / SCREEN_HEIGHT, NEAR = 0.01, FAR = 20000;
	camera = new THREE.PerspectiveCamera( VIEW_ANGLE, ASPECT, NEAR, FAR);
	scene.add(camera);
	camera.position.set(0,40,0);
	// RENDERER
    renderer = new THREE.WebGLRenderer( {antialias:true} );
	renderer.setSize(SCREEN_WIDTH, SCREEN_HEIGHT);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;

	container = document.getElementById( 'ThreeJS' );
	container.appendChild( renderer.domElement );
	// CONTROLS
	controls = new THREE.OrbitControls( camera, renderer.domElement );
	// STATS
	stats = new Stats();
	stats.domElement.style.position = 'absolute';
	stats.domElement.style.bottom = '0px';
	stats.domElement.style.zIndex = 100;
	//container.appendChild( stats.domElement );

	let ambient = new THREE.AmbientLight('#ffffff', 0.5);
	scene.add(ambient);

    let directionalLight = new THREE.DirectionalLight('#ffffff', 0.5);
    directionalLight.position.x = 0;
    directionalLight.position.y = 1000;
    directionalLight.position.z = 0;
    scene.add(directionalLight);

	// FLOOR
	var floorMaterial = new THREE.MeshPhongMaterial( { color: '#444444', side: THREE.DoubleSide } );
	var floorGeometry = new THREE.PlaneGeometry(30, 30, 1, 1);
	var floor = new THREE.Mesh(floorGeometry, floorMaterial);
	floor.rotation.x = Math.PI / 2;
    scene.add(floor);
    
    var wallMaterial = new THREE.MeshPhongMaterial( { color: '#222222', side: THREE.DoubleSide } );
    var wallGeometry = new THREE.PlaneGeometry(30, 5, 1, 1);

	////////////
	// CUSTOM //
	////////////
    world = new CANNON.World();

    world.gravity.set(0, -9.82 * 20, 0);
    world.broadphase = new CANNON.NaiveBroadphase();
    world.solver.iterations = 16;

    DiceManager.setWorld(world);

    //Floor
    let floorBody = new CANNON.Body({mass: 0, shape: new CANNON.Plane(), material: DiceManager.floorBodyMaterial});
    floorBody.quaternion.setFromAxisAngle(new CANNON.Vec3(-1, 0, 0), Math.PI/2);
    world.add(floorBody);

    //Walls
    var northwallShape = new CANNON.Box(new CANNON.Vec3(15,15,1));
    var northwallBody = new CANNON.Body({ mass: 0 });
    northwallBody.addShape(northwallShape);
    northwallBody.position.set(0,0,-15);
    world.addBody(northwallBody);

    var eastwallShape = new CANNON.Box(new CANNON.Vec3(1,15,15));
    var eastwallBody = new CANNON.Body({ mass: 0 });
    eastwallBody.addShape(eastwallShape);
    eastwallBody.position.set(15,0,0);
    world.addBody(eastwallBody);

    var southwallShape = new CANNON.Box(new CANNON.Vec3(15,15,1));
    var southwallBody = new CANNON.Body({ mass: 0 });
    southwallBody.addShape(southwallShape);
    southwallBody.position.set(0,0,15);
    world.addBody(southwallBody);

    var westwallShape = new CANNON.Box(new CANNON.Vec3(1,15,15));
    var westwallBody = new CANNON.Body({ mass: 0 });
    westwallBody.addShape(westwallShape);
    westwallBody.position.set(-15,0,0);
    world.addBody(westwallBody);

    requestAnimationFrame( animate );


    d4 = new DiceD4({size: 1.5, backColor: "#ff00ff"});
    scene.add(d4.getObject());
    dice.push(d4);
    d6 = new DiceD6({size: 1.5, backColor: "#00ffff"});
    scene.add(d6.getObject());
    dice.push(d6);
    d8 = new DiceD8({size: 1.5, backColor: "#00ff00"});
    scene.add(d8.getObject());
    dice.push(d8);
    d10 = new DiceD10({size: 1.5, backColor: "#ffff00"});
    scene.add(d10.getObject());
    dice.push(d10);
    d12 = new DiceD12({size: 1.5, backColor: "#ff8000"});
    scene.add(d12.getObject());
    dice.push(d12);
    d20 = new DiceD20({size: 1.5, backColor: "#ff0000"});
    scene.add(d20.getObject());
    dice.push(d20);

}

function randBetween(a,b){
    var mult = b - a + 1;
    var min = a - 1
	return Math.ceil(Math.random()*mult+min);
}

function randomDiceThrow() {
    for (var i = 0; i < dice.length; i++) {
        dice[i].getObject().position.x = randBetween(-5,5);
        dice[i].getObject().position.y = randBetween(1,5);
        dice[i].getObject().position.z = randBetween(-5,5);
        dice[i].getObject().quaternion.x = randBetween(-45,45) * Math.PI / 180;
        dice[i].getObject().quaternion.y = randBetween(-45,45) * Math.PI / 180;
        dice[i].getObject().quaternion.z = randBetween(-45,45) * Math.PI / 180;
        dice[i].updateBodyFromMesh();
        dice[i].getObject().body.velocity.set(randBetween(-50,50),randBetween(-50,50),randBetween(-50,50));
        dice[i].getObject().body.angularVelocity.set(20 * Math.random() -10, 20 * Math.random() -10, 20 * Math.random() -10);
    }
}
randomDiceThrow();

function animate()
{
    world.step(1.0 / 60.0);
    for (var i in dice) {
        dice[i].updateMeshFromBody();
    }
	renderer.render( scene, camera );
	controls.update();
	stats.update();
    requestAnimationFrame( animate );
}
</script>
</body>
</html>